<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Workflow Dashboard</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		
		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
			background: #0f172a;
			color: #e2e8f0;
			min-height: 100vh;
		}
		
		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
		}
		
		header {
			text-align: center;
			margin-bottom: 30px;
		}
		
		h1 {
			font-size: 2.5rem;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			margin-bottom: 10px;
		}
		
		.subtitle {
			color: #94a3b8;
			font-size: 1.1rem;
		}
		
		.btn {
			padding: 12px 24px;
			border: none;
			border-radius: 8px;
			font-size: 1rem;
			cursor: pointer;
			transition: all 0.3s ease;
			font-weight: 600;
			display: inline-flex;
			align-items: center;
			gap: 8px;
		}
		
		.btn-primary {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
		}
		
		.btn-primary:hover {
			transform: translateY(-2px);
			box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
		}
		
		.btn-continue {
			background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
			color: white;
		}
		
		.btn-continue:hover {
			transform: translateY(-2px);
			box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
		}
		
		.btn-retry {
			background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
			color: white;
		}
		
		.btn-retry:hover {
			transform: translateY(-2px);
			box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3);
		}
		
		.btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
			transform: none !important;
		}
		
		.main-grid {
			display: grid;
			grid-template-columns: 1fr 350px;
			gap: 30px;
			margin-bottom: 30px;
		}
		
		@media (max-width: 900px) {
			.main-grid {
				grid-template-columns: 1fr;
			}
		}
		
		.card {
			background: #1e293b;
			border-radius: 12px;
			padding: 24px;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		}
		
		.card h2 {
			font-size: 1.3rem;
			margin-bottom: 20px;
			color: #f8fafc;
			display: flex;
			align-items: center;
			gap: 10px;
		}
		
		.current-workflow {
			min-height: 400px;
		}
		
		.no-workflow {
			text-align: center;
			padding: 60px 20px;
			color: #64748b;
		}
		
		.no-workflow-icon {
			font-size: 4rem;
			margin-bottom: 20px;
			opacity: 0.5;
		}
		
		.workflow-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 20px;
			padding-bottom: 20px;
			border-bottom: 1px solid #334155;
		}
		
		.workflow-id {
			font-family: monospace;
			font-size: 0.9rem;
			color: #94a3b8;
		}
		
		.status-badge {
			padding: 6px 12px;
			border-radius: 20px;
			font-size: 0.85rem;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}
		
		.status-running {
			background: rgba(59, 130, 246, 0.2);
			color: #60a5fa;
		}
		
		.status-waiting {
			background: rgba(245, 158, 11, 0.2);
			color: #fbbf24;
		}
		
		.status-completed {
			background: rgba(34, 197, 94, 0.2);
			color: #4ade80;
		}
		
		.status-failed {
			background: rgba(239, 68, 68, 0.2);
			color: #f87171;
		}
		
		.status-queued {
			background: rgba(148, 163, 184, 0.2);
			color: #cbd5e1;
		}
		
		.progress-bar {
			height: 8px;
			background: #334155;
			border-radius: 4px;
			overflow: hidden;
			margin-bottom: 30px;
		}
		
		.progress-fill {
			height: 100%;
			background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
			border-radius: 4px;
			transition: width 0.5s ease;
		}
		
		.steps-container {
			display: flex;
			flex-direction: column;
			gap: 16px;
		}
		
		.step {
			background: #0f172a;
			border-radius: 8px;
			padding: 16px;
			border-left: 4px solid #334155;
			transition: all 0.3s ease;
		}
		
		.step:hover {
			background: #1e293b;
		}
		
		.step-running {
			border-left-color: #60a5fa;
			background: rgba(59, 130, 246, 0.1);
		}
		
		.step-waiting {
			border-left-color: #fbbf24;
			background: rgba(245, 158, 11, 0.1);
		}
		
		.step-completed {
			border-left-color: #4ade80;
		}
		
		.step-failed {
			border-left-color: #f87171;
			background: rgba(239, 68, 68, 0.1);
		}
		
		.step-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 8px;
		}
		
		.step-number {
			background: #334155;
			color: #94a3b8;
			width: 28px;
			height: 28px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 0.85rem;
			font-weight: 600;
		}
		
		.step-running .step-number {
			background: #3b82f6;
			color: white;
		}
		
		.step-waiting .step-number {
			background: #f59e0b;
			color: white;
		}
		
		.step-completed .step-number {
			background: #22c55e;
			color: white;
		}
		
		.step-failed .step-number {
			background: #ef4444;
			color: white;
		}
		
		.step-title {
			font-weight: 600;
			color: #f8fafc;
			flex: 1;
			margin: 0 12px;
		}
		
		.step-status {
			font-size: 0.8rem;
			padding: 4px 8px;
			border-radius: 4px;
			background: #334155;
			color: #94a3b8;
		}
		
		.step-meta {
			font-size: 0.8rem;
			color: #64748b;
			margin-top: 4px;
			display: flex;
			gap: 16px;
		}
		
		.step-output {
			margin-top: 12px;
			padding: 12px;
			background: #0f172a;
			border-radius: 6px;
			font-family: monospace;
			font-size: 0.85rem;
			color: #94a3b8;
			overflow-x: auto;
			white-space: pre-wrap;
			word-break: break-all;
			max-height: 200px;
			overflow-y: auto;
		}
		
		.step-error {
			margin-top: 12px;
			padding: 12px;
			background: rgba(239, 68, 68, 0.1);
			border-radius: 6px;
			color: #f87171;
			font-size: 0.9rem;
		}
		
		.history-list {
			max-height: 500px;
			overflow-y: auto;
		}
		
		.history-item {
			padding: 12px;
			border-radius: 8px;
			margin-bottom: 8px;
			background: #0f172a;
			cursor: pointer;
			transition: all 0.2s ease;
			border: 1px solid transparent;
		}
		
		.history-item:hover {
			background: #1e293b;
			border-color: #334155;
		}
		
		.history-item.active {
			border-color: #667eea;
			background: rgba(102, 126, 234, 0.1);
		}
		
		.history-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 6px;
		}
		
		.history-id {
			font-family: monospace;
			font-size: 0.8rem;
			color: #64748b;
		}
		
		.history-time {
			font-size: 0.75rem;
			color: #475569;
		}
		
		.actions-bar {
			display: flex;
			gap: 12px;
			margin-top: 20px;
			padding-top: 20px;
			border-top: 1px solid #334155;
		}
		
		.spinner {
			display: inline-block;
			width: 16px;
			height: 16px;
			border: 2px solid rgba(255, 255, 255, 0.3);
			border-radius: 50%;
			border-top-color: white;
			animation: spin 0.8s linear infinite;
		}
		
		@keyframes spin {
			to { transform: rotate(360deg); }
		}
		
		.connection-status {
			position: fixed;
			top: 20px;
			right: 20px;
			padding: 8px 16px;
			border-radius: 20px;
			font-size: 0.8rem;
			font-weight: 600;
			z-index: 1000;
		}
		
		.connection-online {
			background: rgba(34, 197, 94, 0.2);
			color: #4ade80;
		}
		
		.connection-offline {
			background: rgba(239, 68, 68, 0.2);
			color: #f87171;
		}
		
		.retry-indicator {
			font-size: 0.8rem;
			color: #fbbf24;
			margin-top: 4px;
		}
	</style>
</head>
<body>
	<div id="connectionStatus" class="connection-status connection-offline">‚óè Offline</div>
	
	<div class="container">
		<header>
			<h1>Workflow Dashboard</h1>
			<p class="subtitle">Monitor and control your workflow instances in real-time</p>
		</header>
		
		<div class="main-grid">
			<div class="card current-workflow">
				<div id="workflowContent">
					<div class="no-workflow">
						<div class="no-workflow-icon">üîÑ</div>
						<h3>No Active Workflow</h3>
						<p style="margin: 10px 0 20px;">Start a new workflow to see it in action</p>
						<button class="btn btn-primary" onclick="startWorkflow()">
							Start New Workflow
						</button>
					</div>
				</div>
			</div>
			
			<div class="card">
				<h2>üìã History</h2>
				<div id="historyList" class="history-list">
					<p style="color: #64748b; text-align: center; padding: 20px;">No workflow history</p>
				</div>
			</div>
		</div>
	</div>

	<script>
		let currentInstanceId = null;
		let eventSource = null;
		let workflowHistory = [];
		
		function updateConnectionStatus(connected) {
			const status = document.getElementById('connectionStatus');
			if (connected) {
				status.className = 'connection-status connection-online';
				status.textContent = '‚óè Live';
			} else {
				status.className = 'connection-status connection-offline';
				status.textContent = '‚óè Offline';
			}
		}
		
		async function startWorkflow() {
			try {
				const response = await fetch('/api/workflow', { method: 'POST' });
				const data = await response.json();
				currentInstanceId = data.id;
				connectToStream(data.id);
				renderWorkflow(data);
				updateHistory();
			} catch (error) {
				alert('Failed to start workflow: ' + error.message);
			}
		}
		
		async function continueWorkflow() {
			if (!currentInstanceId) return;
			try {
				await fetch(`/api/workflow/${currentInstanceId}/continue`, { method: 'POST' });
			} catch (error) {
				alert('Failed to continue workflow: ' + error.message);
			}
		}
		
		async function retryWorkflow() {
			if (!currentInstanceId) return;
			try {
				await fetch(`/api/workflow/${currentInstanceId}/retry`, { method: 'POST' });
			} catch (error) {
				alert('Failed to retry workflow: ' + error.message);
			}
		}
		
		function connectToStream(instanceId) {
			if (eventSource) {
				eventSource.close();
			}
			
			eventSource = new EventSource(`/api/stream?instanceId=${instanceId}`);
			
			eventSource.onopen = () => {
				updateConnectionStatus(true);
			};
			
			eventSource.onerror = () => {
				updateConnectionStatus(false);
			};
			
			eventSource.onmessage = (event) => {
				try {
					const data = JSON.parse(event.data);
					if (data.instance) {
						renderWorkflow(data.instance);
						updateHistory();
					}
				} catch (e) {
					console.error('Failed to parse SSE data:', e);
				}
			};
		}
		
		function renderWorkflow(instance) {
			const container = document.getElementById('workflowContent');
			const completedSteps = instance.steps.filter(s => s.status === 'completed').length;
			const progress = (completedSteps / instance.steps.length) * 100;
			
			let html = `
				<div class="workflow-header">
					<span class="workflow-id">ID: ${instance.id.slice(0, 8)}...</span>
					<span class="status-badge status-${instance.status}">${instance.status}</span>
				</div>
				
				<div class="progress-bar">
					<div class="progress-fill" style="width: ${progress}%"></div>
				</div>
				
				<div class="steps-container">
			`;
			
			instance.steps.forEach((step, index) => {
			const hasOutput = step.output !== undefined && step.output !== null;
			const hasError = step.error !== undefined && step.error !== null;
				const duration = step.duration ? `(${(step.duration / 1000).toFixed(1)}s)` : '';
				
				html += `
					<div class="step step-${step.status}">
						<div class="step-header">
							<span class="step-number">${index + 1}</span>
							<span class="step-title">${step.name}</span>
							<span class="step-status">${step.status}</span>
						</div>
						<div class="step-meta">
							<span>${new Date(step.timestamp).toLocaleTimeString()}</span>
							<span>${duration}</span>
						</div>
				`;
				
				if (hasOutput) {
					html += `<div class="step-output">${JSON.stringify(step.output, null, 2)}</div>`;
				}
				
				if (hasError) {
					html += `<div class="step-error">Error: ${step.error}</div>`;
				}
				
				html += '</div>';
			});
			
			html += '</div>';
			
			// Actions bar
			html += '<div class="actions-bar">';
			
			if (instance.status === 'waiting') {
				html += `<button class="btn btn-continue" onclick="continueWorkflow()">Continue</button>`;
			} else if (instance.status === 'failed') {
				html += `<button class="btn btn-retry" onclick="retryWorkflow()">Retry</button>`;
			} else if (instance.status === 'completed') {
				html += `<button class="btn btn-primary" onclick="startWorkflow()">Start New Workflow</button>`;
			}
			
			html += '</div>';
			
			container.innerHTML = html;
		}
		
		async function updateHistory() {
			try {
				const response = await fetch('/api/workflows');
				workflowHistory = await response.json();
				renderHistory();
			} catch (error) {
				console.error('Failed to load history:', error);
			}
		}
		
		function renderHistory() {
			const container = document.getElementById('historyList');
			
			if (workflowHistory.length === 0) {
				container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">No workflow history</p>';
				return;
			}
			
			const sorted = [...workflowHistory].sort((a, b) => b.startTime - a.startTime);
			
			container.innerHTML = sorted.map(instance => {
				const duration = instance.endTime 
					? `${((instance.endTime - instance.startTime) / 1000).toFixed(1)}s`
					: 'Running...';
				const isActive = instance.id === currentInstanceId;
				
				return `
					<div class="history-item ${isActive ? 'active' : ''}" onclick="selectWorkflow('${instance.id}')">
						<div class="history-header">
							<span class="history-id">${instance.id.slice(0, 12)}...</span>
							<span class="status-badge status-${instance.status}">${instance.status}</span>
						</div>
						<div class="history-time">
							${new Date(instance.startTime).toLocaleString()} ¬∑ ${duration}
						</div>
					</div>
				`;
			}).join('');
		}
		
		async function selectWorkflow(id) {
			currentInstanceId = id;
			try {
				const response = await fetch(`/api/workflow/${id}`);
				const instance = await response.json();
				renderWorkflow(instance);
				connectToStream(id);
				renderHistory();
			} catch (error) {
				console.error('Failed to load workflow:', error);
			}
		}
		
		// Load history on page load
		updateHistory();
	</script>
</body>
</html>